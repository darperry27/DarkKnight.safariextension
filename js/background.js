var popover = null;
function performCommand(event) {
    if (event.command === "Lights") {
		if ((safari.extension.settings.getItem("alllightsoff")!="true") && (safari.extension.settings.getItem("alllightsoff")!=true)){
			
			for(var i = 0; i < safari.extension.toolbarItems.length; i++){
				
        		if(safari.extension.toolbarItems[i].identifier == "Lights"){browseraction = safari.extension.toolbarItems[i];}
    		}
			safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("lightsoff", "there");
			if(browseraction.popover) {
				popover.hide();
				event.target.popover = null;
				popover = null;
			}
		} 
	}
}

function waitForMessage(e) {
    if (e.target !== safari.application.activeBrowserWindow.activeTab){
		return;
	}
	if(e.name === "getSettings" && e.message === "now") {
        e.target.page.dispatchMessage("setSettings", {manifestversion:safari.extension.displayVersion, lightcolor:safari.extension.settings.getItem("lightcolor"), interval:safari.extension.settings.getItem("interval"), fadein:safari.extension.settings.getItem("fadein"), fadeout:safari.extension.settings.getItem("fadeout"), autoplay:safari.extension.settings.getItem("autoplay"), eastereggs:safari.extension.settings.getItem("eastereggs"), suggestions:safari.extension.settings.getItem("suggestions"), playlist:safari.extension.settings.getItem("playlist"), sharebutton:safari.extension.settings.getItem("sharebutton"), videoheadline:safari.extension.settings.getItem("videoheadline"), flash:safari.extension.settings.getItem("flash"), head:safari.extension.settings.getItem("head"), infobar:safari.extension.settings.getItem("infobar"), likebutton:safari.extension.settings.getItem("likebutton"), shortcutlight:safari.extension.settings.getItem("shortcutlight"), readera:safari.extension.settings.getItem("readera"), readern:safari.extension.settings.getItem("readern"), eyea:safari.extension.settings.getItem("eyea"), eyen:safari.extension.settings.getItem("eyen"), readerlargestyle:safari.extension.settings.getItem("readerlargestyle"), viewcount:safari.extension.settings.getItem("viewcount"), lightimage:safari.extension.settings.getItem("lightimage"), lightimagea:safari.extension.settings.getItem("lightimagea"), lightimagen:safari.extension.settings.getItem("lightimagen"), eyealist:safari.extension.settings.getItem("eyealist"), excludedDomains:safari.extension.settings.excludedDomains, mousespotlighto:safari.extension.settings.getItem("mousespotlighto"), mousespotlighta:safari.extension.settings.getItem("mousespotlighta"), mousespotlightc:safari.extension.settings.getItem("mousespotlightc"), nighttime:safari.extension.settings.getItem("nighttime"), begintime:safari.extension.settings.getItem("begintime"), endtime:safari.extension.settings.getItem("endtime"), addvideobutton:safari.extension.settings.getItem("addvideobutton"), likebar:safari.extension.settings.getItem("likebar"), ambilight:safari.extension.settings.getItem("ambilight"), ambilightrangeblurradius:safari.extension.settings.getItem("ambilightrangeblurradius"), ambilightrangespreadradius:safari.extension.settings.getItem("ambilightrangespreadradius"), mousespotlightt:safari.extension.settings.getItem("mousespotlightt"), ambilightfixcolor:safari.extension.settings.getItem("ambilightfixcolor"), ambilightvarcolor:safari.extension.settings.getItem("ambilightvarcolor"), ambilightcolorhex:safari.extension.settings.getItem("ambilightcolorhex"), ambilight4color:safari.extension.settings.getItem("ambilight4color"), ambilight1colorhex:safari.extension.settings.getItem("ambilight1colorhex"), ambilight2colorhex:safari.extension.settings.getItem("ambilight2colorhex"), ambilight3colorhex:safari.extension.settings.getItem("ambilight3colorhex"), ambilight4colorhex:safari.extension.settings.getItem("ambilight4colorhex"), password:safari.extension.settings.getItem("password"), enterpassword:safari.extension.settings.getItem("enterpassword"), noflash:safari.extension.settings.getItem("noflash"), hardflash:safari.extension.settings.getItem("hardflash"), ecosaver:safari.extension.settings.getItem("ecosaver"), ecosavertime:safari.extension.settings.getItem("ecosavertime"), dynamic:safari.extension.settings.getItem("dynamic"), dynamic1:safari.extension.settings.getItem("dynamic1"), dynamic2:safari.extension.settings.getItem("dynamic2"), dynamic3:safari.extension.settings.getItem("dynamic3"), dynamic4:safari.extension.settings.getItem("dynamic4"), dynamic5:safari.extension.settings.getItem("dynamic5"), dynamic6:safari.extension.settings.getItem("dynamic6"), dynamic7:safari.extension.settings.getItem("dynamic7"), dynamic8:safari.extension.settings.getItem("dynamic8"), dynamic9:safari.extension.settings.getItem("dynamic9"), dynamic10:safari.extension.settings.getItem("dynamic10"), hoveroptiondyn5:safari.extension.settings.getItem("hoveroptiondyn5"), autoplayonly:safari.extension.settings.getItem("autoplayonly"), autoplayDomains:safari.extension.settings.autoplayDomains, blur:safari.extension.settings.getItem("blur"), youtubequality:safari.extension.settings.getItem("youtubequality"), maxquality:safari.extension.settings.getItem("maxquality"), autowidthyoutube:safari.extension.settings.getItem("autowidthyoutube"), customqualityyoutube:safari.extension.settings.getItem("customqualityyoutube"), cinemaontop:safari.extension.settings.getItem("cinemaontop"), alllightsoff:safari.extension.settings.getItem("alllightsoff"), spotlightradius:safari.extension.settings.getItem("spotlightradius"), atmosphereonly:safari.extension.settings.getItem("atmosphereonly"), atmosphereDomains:safari.extension.settings.atmosphereDomains, optionskipremember:safari.extension.settings.getItem("optionskipremember"), countremember:safari.extension.settings.getItem("countremember"), nighttheme:safari.extension.settings.getItem("nighttheme"), nightonly:safari.extension.settings.getItem("nightonly"), nightenabletheme:safari.extension.settings.getItem("nightenabletheme"), nightDomains:safari.extension.settings.nightDomains, autoplaydelay:safari.extension.settings.getItem("autoplaydelay"), autoplaydelaytime:safari.extension.settings.getItem("autoplaydelaytime"), motion:safari.extension.settings.getItem("motion"), lightimagelin:safari.extension.settings.getItem("lightimagelin"), linearsq:safari.extension.settings.getItem("linearsq"), colora:safari.extension.settings.getItem("colora"), intervallina:safari.extension.settings.getItem("intervallina"), colorb:safari.extension.settings.getItem("colorb"), intervallinb:safari.extension.settings.getItem("intervallinb"), speech:safari.extension.settings.getItem("speech"), speechlang:safari.extension.settings.getItem("speechlang"), speechcountry:safari.extension.settings.getItem("speechcountry"), atmosvivid:safari.extension.settings.getItem("atmosvivid"), cammotiononly:safari.extension.settings.getItem("cammotiononly"), speechonly:safari.extension.settings.getItem("speechonly"), autoplaychecklistwhite:safari.extension.settings.getItem("autoplaychecklistwhite"), autoplaychecklistblack:safari.extension.settings.getItem("autoplaychecklistblack"), cammotionDomains:safari.extension.settings.cammotionDomains, speechDomains:safari.extension.settings.speechDomains, reviewedlastonversion:safari.extension.settings.getItem("reviewedlastonversion"), applastonversion:safari.extension.settings.getItem("applastonversion"), mobilelastonversion:safari.extension.settings.getItem("mobilelastonversion"), autostop:safari.extension.settings.getItem("autostop"), autostoponly:safari.extension.settings.getItem("autostoponly"), autostopchecklistwhite:safari.extension.settings.getItem("autostopchecklistwhite"), autostopchecklistblack:safari.extension.settings.getItem("autostopchecklistblack"), nighthover:safari.extension.settings.getItem("nighthover"), nightmodechecklistwhite:safari.extension.settings.getItem("nightmodechecklistwhite"), nightmodechecklistblack:safari.extension.settings.getItem("nightmodechecklistblack"), nmtopleft:safari.extension.settings.getItem("nmtopleft"), nmtopright:safari.extension.settings.getItem("nmtopright"), nmbottomright:safari.extension.settings.getItem("nmbottomright"), nmbottomleft:safari.extension.settings.getItem("nmbottomleft"), nmcustom:safari.extension.settings.getItem("nmcustom"), nmcustomx: safari.extension.settings.getItem("nmcustomx"), nmcustomy: safari.extension.settings.getItem("nmcustomy"), nightactivetime:safari.extension.settings.getItem("nightactivetime"), nmbegintime:safari.extension.settings.getItem("nmbegintime"), nmendtime:safari.extension.settings.getItem("nmendtime"), lampandnightmode:safari.extension.settings.getItem("lampandnightmode"), eyechecklistwhite:safari.extension.settings.getItem("eyechecklistwhite"), eyechecklistblack:safari.extension.settings.getItem("eyechecklistblack"), autostopDomains:safari.extension.settings.autostopDomains, nightmodebck:safari.extension.settings.getItem("nightmodebck"), nightmodetxt:safari.extension.settings.getItem("nightmodetxt"), no360youtube:safari.extension.settings.getItem("no360youtube"), videotool:safari.extension.settings.getItem("videotool"), reflection:safari.extension.settings.getItem("reflection"), reflectionamount:safari.extension.settings.getItem("reflectionamount"), videotoolonly:safari.extension.settings.getItem("videotoolonly"), videotoolchecklistwhite:safari.extension.settings.getItem("videotoolchecklistwhite"), videotoolchecklistblack:safari.extension.settings.getItem("videotoolchecklistblack"), videotoolDomains:safari.extension.settings.videotoolDomains, nightmodehyperlink:safari.extension.settings.getItem("nightmodehyperlink"), block60fps:safari.extension.settings.getItem("block60fps"), videovolume:safari.extension.settings.getItem("videovolume"), videovolumecolor:safari.extension.settings.getItem("videovolumecolor"), videovolumesteps:safari.extension.settings.getItem("videovolumesteps"), videovolumelabel:safari.extension.settings.getItem("videovolumelabel"), icon:safari.extension.settings.getItem("icon"), visopacity:safari.extension.settings.getItem("visopacity")
		});
	}
	else {
		return
	}
}

var browseraction = null;
var lampmenu = null;
var sharemenu = null;
function removemenu(menu){safari.extension.removeMenu(menu.identifier);}

safari.application.addEventListener("command", performCommand, false);
safari.application.addEventListener("message", waitForMessage, false);